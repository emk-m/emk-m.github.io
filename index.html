<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Frame-Accurate Compound Blur Video</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f7f7f7;
      font-family: sans-serif;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .ui {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: #111;
      z-index: 10;
    }

    .ui button, .ui input[type=file], .ui label {
      font-size: 14px;
      background: #fff;
      border: 1px solid #aaa;
      color: #111;
      padding: 5px 10px;
      cursor: pointer;
    }

    .ui .filename {
      font-size: 13px;
      color: #333;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sliders {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      color: #111;
      z-index: 10;
    }

    .slider-container {
      display: flex;
      flex-direction: column;
      font-size: 14px;
    }

    input[type=range] {
      width: 180px;
      -webkit-appearance: none;
      height: 6px;
      background: #ccc;
      border-radius: 3px;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: #111;
      border-radius: 0;
      cursor: pointer;
    }

    #frame {
      width: 720px;
      height: 540px;
      background: #000;
      overflow: hidden;
      position: relative;
    }

    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <div class="ui">
    <label>
      Choose File
      <input type="file" id="fileInput" accept="video/*" style="display:none;">
    </label>
    <button id="webcamBtn">Use Webcam</button>
    <div class="filename" id="filename">No file selected</div>
  </div>

  <div class="sliders">
    <div class="slider-container">
      <label>Opacity</label>
      <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1">
    </div>

    <div class="slider-container">
      <label>Compound Blur Max</label>
      <input type="range" id="maxBlurSlider" min="0" max="40" step="1" value="0">
    </div>

    <div class="slider-container">
      <label><input type="checkbox" id="invertToggle"> Invert</label>
    </div>

    <div class="slider-container">
      <label><input type="checkbox" id="compoundToggle">Compound Blur</label>
    </div>

    <div class="slider-container">
      <label>Time Difference (frames)</label>
      <input type="range" id="timeDiffSlider" min="0" max="30" step="1" value="0">
    </div>
    
    <div class="slider-container">
      <label>Posterize</label>
      <input type="range" id="posterizeSlider" min="2" max="32" step="1" value="32">
    </div>

    <div class="slider-container">
      <label>Playback Speed</label>
      <input type="range" id="speedSlider" min="0.1" max="3" step="0.05" value="1">
    </div>
    
    
  </div>

  <div id="frame"></div>

  <script>
    let video, capture;
    let usingWebcam = false;
    let opacitySlider, maxBlurSlider, invertToggle, compoundToggle;
    let referenceLayer;
    let timeDiffSlider, posterizeSlider;
    let previousFrames = []; // buffer to store previous frames for time difference
    let speedSlider;
    let blurredFrame = applyCompoundBlur(effectFrame, referenceFrame);





    function setup() {
      let frame = select('#frame');
      let cnv = createCanvas(720, 540);
      cnv.parent(frame);
      noLoop();

      opacitySlider = select('#opacitySlider');
      maxBlurSlider = select('#maxBlurSlider');
      invertToggle = select('#invertToggle');
      compoundToggle = select('#compoundToggle');
      timeDiffSlider = select('#timeDiffSlider');
      posterizeSlider = select('#posterizeSlider');



      referenceLayer = createGraphics(width, height);

      select('#fileInput').changed(handleFile);
      select('#webcamBtn').mousePressed(toggleWebcam);

      opacitySlider.input(redraw);
      maxBlurSlider.input(redraw);
      invertToggle.changed(redraw);
      compoundToggle.changed(redraw);
      timeDiffSlider.input(redraw);
      posterizeSlider.input(redraw);
    }

    function draw() {
      background(0);

      if (!video) return;

      video.loadPixels();
      referenceLayer.image(video, 0, 0, width, height);
      referenceLayer.loadPixels();

      if (compoundToggle.elt.checked) {
        applyCompoundBlur(video, referenceLayer, maxBlurSlider.value());
      }

      push();
      translate(width/2, height/2);
      imageMode(CENTER);
      tint(255, opacitySlider.value() * 255);
      image(video, 0, 0);
      pop();

      if (invertToggle.elt.checked) {
        loadPixels();
        for (let i=0; i<pixels.length; i+=4){
          pixels[i] = 255 - pixels[i];
          pixels[i+1] = 255 - pixels[i+1];
          pixels[i+2] = 255 - pixels[i+2];
        }
        updatePixels();
      }
    }

    function handleFile(event){
      const file = event.target.files[0];
      if (file) {
        select('#filename').html(file.name);
        if (capture) { capture.remove(); capture=null; usingWebcam=false; }
        if (video) video.remove();
        video = createVideo(URL.createObjectURL(file), () => {
          video.loop();
          video.volume(0);
          video.hide();
          loop();
        });
      }
    }

    function toggleWebcam(){
      if (!usingWebcam) {
        select('#filename').html('Webcam active');
        if (video) video.remove();
        capture = createCapture(VIDEO);
        capture.size(720, 540);
        capture.hide();
        video = capture;
        usingWebcam = true;
        loop();
      } else {
        capture.remove();
        capture = null;
        usingWebcam = false;
        select('#filename').html('No file selected');
        video = null;
        noLoop();
      }
    }

// ---- Compound Blur Effect ----
// Apply blur intensity based on luminance of reference layer

// ---- Compound Blur Effect ----
// Uses reference layer luminance to control blur radius per pixel

function applyCompoundBlur(effectFrame, referenceFrame) {
  const baseBlur = 20; // fixed blur strength
  effectFrame.loadPixels();
  referenceFrame.loadPixels();

  const d = pixelDensity();
  const w = effectFrame.width * d;
  const h = effectFrame.height * d;

  const result = createImage(effectFrame.width, effectFrame.height);
  result.loadPixels();

  // Pixel step to speed up (sample every 2 pixels)
  const step = 1;

  for (let y = 0; y < h; y += step) {
    for (let x = 0; x < w; x += step) {
      const i = 4 * (y * w + x);

      // Luminance of reference controls blur radius
      const r = referenceFrame.pixels[i];
      const g = referenceFrame.pixels[i + 1];
      const b = referenceFrame.pixels[i + 2];
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      const blurRadius = luminance * baseBlur;

      let sumR = 0, sumG = 0, sumB = 0, count = 0;

      // Separable horizontal blur approximation
      for (let ox = -blurRadius; ox <= blurRadius; ox += step) {
        const sx = constrain(x + ox, 0, w - 1);
        const si = 4 * (y * w + sx);
        sumR += effectFrame.pixels[si];
        sumG += effectFrame.pixels[si + 1];
        sumB += effectFrame.pixels[si + 2];
        count++;
      }

      result.pixels[i] = sumR / count;
      result.pixels[i + 1] = sumG / count;
      result.pixels[i + 2] = sumB / count;
      result.pixels[i + 3] = 255;
    }
  }

  result.updatePixels();
  return result;
}


   
   
let levels = posterizeSlider.value();
if(levels < 32){ // only apply if less than max
  loadPixels();
  for(let i=0; i<pixels.length; i+=4){
    pixels[i]   = floor(pixels[i]   / 255 * levels) / levels * 255;
    pixels[i+1] = floor(pixels[i+1] / 255 * levels) / levels * 255;
    pixels[i+2] = floor(pixels[i+2] / 255 * levels) / levels * 255;
  }
  updatePixels();
}

if(timeDiffSlider.value() > 0){
  let frameOffset = timeDiffSlider.value(); // number of frames back

  // Store current frame in buffer
  previousFrames.push(video.get()); // make a copy of current frame

  if(previousFrames.length > frameOffset){
    let pastFrame = previousFrames[previousFrames.length - 1 - frameOffset];

    video.loadPixels();
    pastFrame.loadPixels();

    for(let i = 0; i < video.pixels.length; i += 4){
      // Compute per-channel absolute difference
      let diffR = video.pixels[i]   - pastFrame.pixels[i];
      let diffG = video.pixels[i+1] - pastFrame.pixels[i+1];
      let diffB = video.pixels[i+2] - pastFrame.pixels[i+2];

      video.pixels[i]   = abs(diffR);
      video.pixels[i+1] = abs(diffG);
      video.pixels[i+2] = abs(diffB);
      // alpha remains unchanged
    }

    video.updatePixels();
  }

  // Limit buffer size for memory efficiency
  if(previousFrames.length > frameOffset + 5){
    previousFrames.shift();
  }
} else {
  // If slider is zero, just apply compound blur normally
  applyCompoundBlur(video, referenceLayer, maxBlurSlider.value());
}



speedSlider = select('#speedSlider');
speedSlider.input(() => {
  if(video) video.speed(speedSlider.value());
});


  </script>
</body>
</html>

